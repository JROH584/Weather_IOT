<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Environment Dashboard - Realtime</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4e54c8; --secondary-color: #8f94fb; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh; color: #333;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: transform 0.3s ease;
            height: 100%;
        }
        .glass-panel:hover { transform: translateY(-5px); }
        .header-section { text-align: center; color: white; margin-bottom: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .stat-card-body { padding: 25px; position: relative; overflow: hidden; }
        .stat-icon { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-20deg); }
        .stat-value { font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 0.9rem; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        
        .text-temp { color: #ff6b6b; } 
        .text-hum { color: #4facfe; } 
        .text-pres { color: #9b59b6; }

        .ai-header { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 20px 20px 0 0; display: flex; align-items: center; justify-content: space-between; }
        .ai-content { padding: 20px; }
        .advice-item { background: rgba(248, 249, 250, 0.8); border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #ccc; display: flex; align-items: center; }
        .advice-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; flex-shrink: 0;}
        .status-badge { padding: 8px 15px; border-radius: 30px; font-weight: 600; color: white; display: inline-block; width: 100%; text-align: center; margin-top: 10px; transition: 0.3s; }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="header-section">
            <h1 class="fw-bold"><i class="fas fa-microchip"></i> H·ªá Th·ªëng Gi√°m S√°t ESP32</h1>
            <p class="fs-5" id="greeting">Ch√†o m·ª´ng b·∫°n!</p>
        </div>

        <div class="row g-3 mb-4 justify-content-center">
            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-thermometer-half me-2"></i>Nhi·ªát ƒë·ªô</div>
                    <div class="stat-value text-temp mt-2"><span id="temp-val">--</span><span class="unit fs-6">¬∞C</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-temp" class="progress-bar bg-danger" style="width: 0%"></div></div>
                    <i class="fas fa-fire stat-icon text-temp"></i>
                </div>
            </div>
            
            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-tint me-2"></i>ƒê·ªô ·∫©m</div>
                    <div class="stat-value text-hum mt-2"><span id="hum-val">--</span><span class="unit fs-6">%</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-hum" class="progress-bar bg-info" style="width: 0%"></div></div>
                    <i class="fas fa-water stat-icon text-hum"></i>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-tachometer-alt me-2"></i>√Åp su·∫•t</div>
                    <div class="stat-value text-pres mt-2"><span id="pres-val">--</span><span class="unit fs-6">hPa</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-pres" class="progress-bar" style="background-color: #9b59b6; width: 0%"></div></div>
                    <i class="fas fa-compress-arrows-alt stat-icon text-pres"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="glass-panel h-100 p-0 d-flex flex-column">
                    <div class="ai-header">
                        <span class="fw-bold"><i class="fas fa-robot me-2"></i>Tr·ª£ L√Ω Th√¥ng Minh</span>
                        <span id="ai-status-emoji" style="font-size: 1.5rem;">üì°</span>
                    </div>
                    <div class="ai-content flex-grow-1">
                        <div class="advice-item" style="border-color: #ff6b6b;">
                            <div class="advice-icon bg-danger"><i class="fas fa-tshirt"></i></div>
                            <div><small class="text-muted d-block">Trang ph·ª•c</small><span id="msg-temp" class="fw-bold">ƒêang ph√¢n t√≠ch...</span></div>
                        </div>
                        <div class="advice-item" style="border-color: #9b59b6;">
                            <div class="advice-icon" style="background-color: #9b59b6;"><i class="fas fa-heartbeat"></i></div>
                            <div><small class="text-muted d-block">S·ª©c kh·ªèe</small><span id="msg-pres" class="fw-bold">ƒêang ph√¢n t√≠ch...</span></div>
                        </div>
                        <div class="advice-item" style="border-color: #23d5ab;">
                            <div class="advice-icon" style="background-color: #23d5ab;"><i class="fas fa-clock"></i></div>
                            <div><small class="text-muted d-block">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</small><span id="last-update" class="fw-bold">--:--:--</span></div>
                        </div>
                        
                        <div id="main-alert" class="status-badge bg-secondary">ƒêang k·∫øt n·ªëi...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="glass-panel p-4 h-100">
                    <h5 class="fw-bold mb-3 text-secondary"><i class="fas fa-chart-line me-2"></i>Bi·ªÉu ƒë·ªì L·ªãch s·ª≠ (Realtime t·ª´ ESP32)</h5>
                    <div style="height: 300px;"><canvas id="envChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
                ? "http://localhost:5000/api/env-data" 
                : "/api/env-data";
        let lastPressure = null;

        // 1. Kh·ªüi t·∫°o Bi·ªÉu ƒë·ªì
        const ctx = document.getElementById('envChart').getContext('2d');
        const envChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { 
                        label: 'Nhi·ªát ƒë·ªô (¬∞C)', 
                        borderColor: '#ff6b6b', 
                        backgroundColor: 'rgba(255, 107, 107, 0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    { 
                        label: 'ƒê·ªô ·∫©m (%)', 
                        borderColor: '#4facfe', 
                        backgroundColor: 'rgba(79, 172, 254, 0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C)' } },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'ƒê·ªô ·∫©m (%)' } }
                }
            }
        });

        // 2. H√†m Hi·ªÉn th·ªã d·ªØ li·ªáu v√† l√†m tr√≤n s·ªë
        function displayRealData(temp, hum, pressure, timestamp) {
            // T·ªëi ∆∞u: L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n b·∫±ng .toFixed(1)
            const fTemp = parseFloat(temp).toFixed(1);
            const fHum = parseFloat(hum).toFixed(1);
            const fPres = parseFloat(pressure).toFixed(1);

            document.getElementById('temp-val').innerText = fTemp;
            document.getElementById('hum-val').innerText = fHum;
            document.getElementById('pres-val').innerText = fPres;
            document.getElementById('last-update').innerText = new Date(timestamp).toLocaleTimeString('vi-VN');
            
            // C·∫≠p nh·∫≠t progress bars
            document.getElementById('prog-temp').style.width = Math.min((temp / 50 * 100), 100) + '%';
            document.getElementById('prog-hum').style.width = hum + '%';
            
            // Scale √°p su·∫•t t·ª´ 950 ƒë·∫øn 1050 ƒë·ªÉ th·∫•y s·ª± thay ƒë·ªïi r√µ h∆°n
            let presPercent = ((pressure - 950) / 100) * 100;
            document.getElementById('prog-pres').style.width = Math.max(5, Math.min(presPercent, 100)) + '%';

            // Ph√¢n t√≠ch AI v√† c·∫£nh b√°o √°p su·∫•t ƒë·ª©ng y√™n
            document.getElementById('msg-temp').innerText = temp < 20 ? "Tr·ªùi l·∫°nh, h√£y m·∫∑c ·∫•m." : (temp < 32 ? "Th·ªùi ti·∫øt r·∫•t d·ªÖ ch·ªãu." : "Tr·ªùi n√≥ng, h·∫°n ch·∫ø ra ngo√†i.");
            
            let pressureAdvice = "√Åp su·∫•t ·ªïn ƒë·ªãnh, tr·ªùi quang.";
            if (lastPressure !== null && Math.abs(lastPressure - pressure) > 2) {
                pressureAdvice = "√Åp su·∫•t bi·∫øn ƒë·ªông m·∫°nh, c√≥ th·ªÉ c√≥ m∆∞a/b√£o!";
                document.getElementById('ai-status-emoji').innerText = "‚ö†Ô∏è";
            } else {
                document.getElementById('ai-status-emoji').innerText = "‚úÖ";
            }
            document.getElementById('msg-pres').innerText = pressureAdvice;
            
            lastPressure = pressure; // L∆∞u l·∫°i ƒë·ªÉ so s√°nh l·∫ßn sau
        }

        // 3. L·∫•y d·ªØ li·ªáu t·ª´ Server
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Server response error");
                
                const history = await response.json();
                
                if (history && history.length > 0) {
                    const latest = history[0]; 
                    
                    displayRealData(latest.temperature, latest.humidity, latest.pressure, latest.timestamp);
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
                    const alertBox = document.getElementById('main-alert');
                    alertBox.className = "status-badge bg-success";
                    alertBox.innerText = "K·∫øt n·ªëi ·ªïn ƒë·ªãnh";

                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì n·∫øu c√≥ d·ªØ li·ªáu m·ªõi
                    const timeLabel = new Date(latest.timestamp).toLocaleTimeString('vi-VN');
                    if (envChart.data.labels[envChart.data.labels.length - 1] !== timeLabel) {
                        envChart.data.labels.push(timeLabel);
                        envChart.data.datasets[0].data.push(latest.temperature);
                        envChart.data.datasets[1].data.push(latest.humidity);
                        
                        if(envChart.data.labels.length > 20) {
                            envChart.data.labels.shift();
                            envChart.data.datasets.forEach(d => d.data.shift());
                        }
                        envChart.update('none'); // Update m∆∞·ª£t kh√¥ng c·∫ßn animation l·∫°i to√†n b·ªô
                    }
                }
            } catch (err) { 
                console.error("L·ªói l·∫•y d·ªØ li·ªáu:", err);
                const alertBox = document.getElementById('main-alert');
                alertBox.className = "status-badge bg-danger";
                alertBox.innerText = "M·∫•t k·∫øt n·ªëi Server!";
            }
        }

        // 4. Kh·ªüi ch·∫°y
        setInterval(fetchData, 2000); // L·∫•y d·ªØ li·ªáu m·ªói 2 gi√¢y
        fetchData(); // Ch·∫°y l·∫ßn ƒë·∫ßu ngay l·∫≠p t·ª©c

        const hour = new Date().getHours();
        document.getElementById('greeting').innerText = hour < 12 ? "Ch√†o bu·ªïi s√°ng!" : (hour < 18 ? "Ch√†o bu·ªïi chi·ªÅu!" : "Ch√†o bu·ªïi t·ªëi!");
    </script>
</body>
</html>