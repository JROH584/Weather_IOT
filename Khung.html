<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Environment Dashboard - Realtime</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4e54c8; --secondary-color: #8f94fb; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh; color: #333;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: transform 0.3s ease;
            height: 100%;
        }
        .glass-panel:hover { transform: translateY(-5px); }
        .header-section { text-align: center; color: white; margin-bottom: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .stat-card-body { padding: 25px; position: relative; overflow: hidden; }
        .stat-icon { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-20deg); }
        .stat-value { font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 0.9rem; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        
        .text-temp { color: #ff6b6b; } 
        .text-hum { color: #4facfe; } 
        .text-pres { color: #9b59b6; }

        .ai-header { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 20px 20px 0 0; display: flex; align-items: center; justify-content: space-between; }
        .ai-content { padding: 20px; }
        .advice-item { background: rgba(248, 249, 250, 0.8); border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #ccc; display: flex; align-items: center; }
        .advice-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; flex-shrink: 0;}
        .status-badge { padding: 8px 15px; border-radius: 30px; font-weight: 600; color: white; display: inline-block; width: 100%; text-align: center; margin-top: 10px; transition: 0.3s; }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="header-section">
            <h1 class="fw-bold"><i class="fas fa-microchip"></i> H·ªá Th·ªëng Gi√°m S√°t IoT</h1>
            <p class="fs-5" id="greeting">ƒêang t·∫£i...</p>
        </div>

        <div class="row g-3 mb-4 justify-content-center">
            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-thermometer-half me-2"></i>Nhi·ªát ƒë·ªô</div>
                    <div class="stat-value text-temp mt-2"><span id="temp-val">--</span><span class="unit fs-6">¬∞C</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-temp" class="progress-bar bg-danger" style="width: 0%"></div></div>
                    <i class="fas fa-fire stat-icon text-temp"></i>
                </div>
            </div>
            
            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-tint me-2"></i>ƒê·ªô ·∫©m</div>
                    <div class="stat-value text-hum mt-2"><span id="hum-val">--</span><span class="unit fs-6">%</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-hum" class="progress-bar bg-info" style="width: 0%"></div></div>
                    <i class="fas fa-water stat-icon text-hum"></i>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="glass-panel stat-card-body">
                    <div class="stat-label"><i class="fas fa-tachometer-alt me-2"></i>√Åp su·∫•t</div>
                    <div class="stat-value text-pres mt-2"><span id="pres-val">--</span><span class="unit fs-6">hPa</span></div>
                    <div class="progress mt-3" style="height: 6px;"><div id="prog-pres" class="progress-bar" style="background-color: #9b59b6; width: 0%"></div></div>
                    <i class="fas fa-compress-arrows-alt stat-icon text-pres"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="glass-panel h-100 p-0 d-flex flex-column">
                    <div class="ai-header">
                        <span class="fw-bold"><i class="fas fa-robot me-2"></i>Tr·ª£ L√Ω Th√¥ng Minh</span>
                        <span id="ai-status-emoji" style="font-size: 1.5rem;">üì°</span>
                    </div>
                    <div class="ai-content flex-grow-1">
                        <div class="advice-item" style="border-color: #ff6b6b;">
                            <div class="advice-icon bg-danger"><i class="fas fa-tshirt"></i></div>
                            <div><small class="text-muted d-block">Trang ph·ª•c</small><span id="msg-temp" class="fw-bold">ƒêang ph√¢n t√≠ch...</span></div>
                        </div>
                        <div class="advice-item" style="border-color: #9b59b6;">
                            <div class="advice-icon" style="background-color: #9b59b6;"><i class="fas fa-heartbeat"></i></div>
                            <div><small class="text-muted d-block">S·ª©c kh·ªèe</small><span id="msg-pres" class="fw-bold">ƒêang ph√¢n t√≠ch...</span></div>
                        </div>
                        <div class="advice-item" style="border-color: #23d5ab;">
                            <div class="advice-icon" style="background-color: #23d5ab;"><i class="fas fa-clock"></i></div>
                            <div><small class="text-muted d-block">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</small><span id="last-update" class="fw-bold">--:--:--</span></div>
                        </div>
                        
                        <div id="main-alert" class="status-badge bg-secondary">ƒêang k·∫øt n·ªëi...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="glass-panel p-4 h-100">
                    <h5 class="fw-bold mb-3 text-secondary"><i class="fas fa-chart-line me-2"></i>Bi·ªÉu ƒë·ªì L·ªãch s·ª≠ (D·ªØ li·ªáu t·ª´ MongoDB)</h5>
                    <div style="height: 300px;"><canvas id="envChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N API ---
        // T·ª± ƒë·ªông d√πng URL Render n·∫øu kh√¥ng ch·∫°y ·ªü Localhost
        const RENDER_URL = "https://weather-db-iot.onrender.com/api/env-data";
        const API_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
                        ? "http://localhost:5000/api/env-data" 
                        : RENDER_URL;

        let lastPressure = null;

        // 1. Kh·ªüi t·∫°o Bi·ªÉu ƒë·ªì (T·ªëi ∆∞u ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp h∆°n)
        const ctx = document.getElementById('envChart').getContext('2d');
        const envChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { 
                        label: 'Nhi·ªát ƒë·ªô (¬∞C)', 
                        borderColor: '#ff6b6b', 
                        backgroundColor: 'rgba(255, 107, 107, 0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    { 
                        label: 'ƒê·ªô ·∫©m (%)', 
                        borderColor: '#4facfe', 
                        backgroundColor: 'rgba(79, 172, 254, 0.1)', 
                        fill: true, 
                        data: [], 
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nhi·ªát ƒë·ªô (¬∞C)' } },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'ƒê·ªô ·∫©m (%)' } }
                }
            }
        });

        // 2. H√†m x·ª≠ l√Ω hi·ªÉn th·ªã s·ªë li·ªáu
        function displayRealData(temp, hum, pressure, timestamp) {
            const fTemp = parseFloat(temp || 0).toFixed(1);
            const fHum = parseFloat(hum || 0).toFixed(1);
            const fPres = parseFloat(pressure || 0).toFixed(1);

            document.getElementById('temp-val').innerText = fTemp;
            document.getElementById('hum-val').innerText = fHum;
            document.getElementById('pres-val').innerText = fPres;
            
            const dateObj = new Date(timestamp);
            document.getElementById('last-update').innerText = isNaN(dateObj) ? "--:--:--" : dateObj.toLocaleTimeString('vi-VN');
            
            // C·∫≠p nh·∫≠t progress bars
            document.getElementById('prog-temp').style.width = Math.min((temp / 50 * 100), 100) + '%';
            document.getElementById('prog-hum').style.width = hum + '%';
            let presPercent = ((pressure - 950) / 100) * 100;
            document.getElementById('prog-pres').style.width = Math.max(5, Math.min(presPercent, 100)) + '%';

            // Ph√¢n t√≠ch AI ƒë∆°n gi·∫£n
            document.getElementById('msg-temp').innerText = temp < 20 ? "Tr·ªùi l·∫°nh, h√£y m·∫∑c ·∫•m." : (temp < 32 ? "Th·ªùi ti·∫øt r·∫•t d·ªÖ ch·ªãu." : "Tr·ªùi n√≥ng, h√£y b·∫≠t qu·∫°t.");
            
            let pressureAdvice = "√Åp su·∫•t ·ªïn ƒë·ªãnh.";
            if (lastPressure !== null && Math.abs(lastPressure - pressure) > 1) {
                pressureAdvice = "√Åp su·∫•t thay ƒë·ªïi, c√≥ th·ªÉ s·∫Øp m∆∞a.";
                document.getElementById('ai-status-emoji').innerText = "‚òÅÔ∏è";
            } else {
                document.getElementById('ai-status-emoji').innerText = "‚òÄÔ∏è";
            }
            document.getElementById('msg-pres').innerText = pressureAdvice;
            lastPressure = pressure;
        }

        // 3. H√†m l·∫•y d·ªØ li·ªáu ch√≠nh (S·ª≠a l·ªói 404 v√† x·ª≠ l√Ω m·∫£ng r·ªóng)
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Server response error: " + response.status);
                
                const history = await response.json();
                const alertBox = document.getElementById('main-alert');

                if (Array.isArray(history) && history.length > 0) {
                    // Render danh s√°ch t·ª´ c≈© ƒë·∫øn m·ªõi cho bi·ªÉu ƒë·ªì
                    const displayData = [...history].reverse(); 
                    const latest = history[0]; // B·∫£n ghi m·ªõi nh·∫•t (do backend sort -1)

                    displayRealData(latest.temperature, latest.humidity, latest.pressure, latest.timestamp);

                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                    envChart.data.labels = displayData.map(d => new Date(d.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'}));
                    envChart.data.datasets[0].data = displayData.map(d => d.temperature);
                    envChart.data.datasets[1].data = displayData.map(d => d.humidity);
                    envChart.update('none');

                    alertBox.className = "status-badge bg-success";
                    alertBox.innerText = "K·∫øt n·ªëi ·ªïn ƒë·ªãnh";
                } else {
                    alertBox.className = "status-badge bg-warning text-dark";
                    alertBox.innerText = "Ch∆∞a c√≥ d·ªØ li·ªáu t·ª´ ESP32";
                }
            } catch (err) { 
                console.error("L·ªói:", err);
                document.getElementById('main-alert').className = "status-badge bg-danger";
                document.getElementById('main-alert').innerText = "L·ªói k·∫øt n·ªëi Server!";
            }
        }

        // 4. Kh·ªüi ch·∫°y v√† L·ªùi ch√†o
        const hour = new Date().getHours();
        document.getElementById('greeting').innerText = hour < 12 ? "Ch√†o bu·ªïi s√°ng!" : (hour < 18 ? "Ch√†o bu·ªïi chi·ªÅu!" : "Ch√†o bu·ªïi t·ªëi!");

        fetchData(); // Ch·∫°y ngay l·∫≠p t·ª©c
        setInterval(fetchData, 5000); // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y (tr√°nh spam Render Free)
    </script>
</body>
</html>